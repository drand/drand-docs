<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">drand on Filecoin Virtual Machine (FVM) - draffle | drand</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.drand.love/img/league-members.avif"><meta data-rh="true" name="twitter:image" content="https://docs.drand.love/img/league-members.avif"><meta data-rh="true" property="og:url" content="https://docs.drand.love/blog/drand-on-filecoin-virtual-machine-FVM-draffle"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="drand on Filecoin Virtual Machine (FVM) - draffle | drand"><meta data-rh="true" name="description" content="To mark the launch of user-programmable smart contracts on the Filecoin Virtual Machine (FVM), the drand team is excited to release a three-part blog series on using randomness on the FVM! In this first part, we dive into the prevrandao EVM opcode (the FVM fully supports EVM bytecode!), a sample Solidity contract using it, a UI to interact with it, and some other necessary plumbing to make it all work."><meta data-rh="true" property="og:description" content="To mark the launch of user-programmable smart contracts on the Filecoin Virtual Machine (FVM), the drand team is excited to release a three-part blog series on using randomness on the FVM! In this first part, we dive into the prevrandao EVM opcode (the FVM fully supports EVM bytecode!), a sample Solidity contract using it, a UI to interact with it, and some other necessary plumbing to make it all work."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-03-15T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="FVM,Features,How-to"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.drand.love/blog/drand-on-filecoin-virtual-machine-FVM-draffle"><link data-rh="true" rel="alternate" href="https://docs.drand.love/blog/drand-on-filecoin-virtual-machine-FVM-draffle" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.drand.love/blog/drand-on-filecoin-virtual-machine-FVM-draffle" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://docs.drand.love/blog/drand-on-filecoin-virtual-machine-FVM-draffle","mainEntityOfPage":"https://docs.drand.love/blog/drand-on-filecoin-virtual-machine-FVM-draffle","url":"https://docs.drand.love/blog/drand-on-filecoin-virtual-machine-FVM-draffle","headline":"drand on Filecoin Virtual Machine (FVM) - draffle","name":"drand on Filecoin Virtual Machine (FVM) - draffle","description":"To mark the launch of user-programmable smart contracts on the Filecoin Virtual Machine (FVM), the drand team is excited to release a three-part blog series on using randomness on the FVM! In this first part, we dive into the prevrandao EVM opcode (the FVM fully supports EVM bytecode!), a sample Solidity contract using it, a UI to interact with it, and some other necessary plumbing to make it all work.","datePublished":"2023-03-15T00:00:00.000Z","author":{"@type":"Person","name":"Yolan Romailler","description":"Co-Founder & Cryptographer","image":"/img/author/yolan.jpeg"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://docs.drand.love/blog","name":"drand Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="drand RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="drand Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PH6HJ6ECV2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-PH6HJ6ECV2",{})</script><link rel="stylesheet" href="/assets/css/styles.7acb8680.css">
<script src="/assets/js/runtime~main.e93cc406.js" defer="defer"></script>
<script src="/assets/js/main.1808307d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/drand-logo.avif" alt="drand Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/drand-logo.avif" alt="drand Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">drand</b></a><a class="navbar__item navbar__link" href="/docs/home">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/drand/drand-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div style="width:100%;max-height:500px;overflow:hidden"><img src="/img/banner.avif" alt="Banner" style="width:100%;height:100%;object-fit:cover;object-position:center bottom"></div><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/fastnet-sunsetting-dates-set">fastnet sunsetting dates are set</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/create-a-notion-widget">Notion Widget for drand Public Randomness!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/retro-drand-testnet-outage-2024-02-21">Retro on the drand testnet outage of Feb 21, 2024</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/quicknet-live-on-loe-mainnet">quicknet is live!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/announcing-randamu">Announcing Randamu!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/fastnet-to-be-sunset">fastnet to be sunset, long live quicknet</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/announcing-drand-code-walkthrough">Announcing the drand Code Walkthroughs</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/drand-explainer-for-begginers">drand Explainer for Beginners</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/security-assessment-of-tlock">Security Assessment of tlock</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/randomness-summit-tokyo-2023">Randomness Summit Tokyo 2023</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/timelock-encryption-is-now-supported-on-drand-mainnet">Timelock Encryption is now supported on drand mainnet</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/drand-on-filecoin-virtual-machine-FVM-draffle">drand on Filecoin Virtual Machine (FVM) - draffle</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/auttomata-network-joins-the-league-of-entropy">Automata Network Joins the League of Entropy!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/a-guide-on-how-to-use-drand">A Guide on how to use drand</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ipfs-force-joins-the-league-of-entropy">IPFS Force joins the League of Entropy!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/drand-2022-year-in-review-&amp;-our-2023-roadmap">drand: 2022 Year in Review &amp; our 2023 Roadmap</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cryptosat-takes-drand-to-space">CryptoSat takes drand to Space!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/observing-randomness">Observing Randomness</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/drand-at-northsec">drand @ NorthSec</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/storswift-joins-the-league-of-entropy">StorSwift joins the League of Entropy!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/multi-frequency-support-and-timelock-encryption-are-coming-to-drand">Multi-Frequency Support &amp; Timelock Encryption are coming to drand!</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2021</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/the-value-of-drand-part-2-of-2">The Value of drand (Part 2 of 2)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/the-value-of-drand-part-1-of-2">Discover The Value of drand (Part 1 of 2)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/drand-celebrates-one-year-as-a-randomness-service">drand celebrates One Year as a Randomness Service!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/the-league-of-entrophy-welcomes-quantum-resistant-ledger">The League of Entrophy welcomes Quantum Resistant Ledger (QRL)</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2020</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/join-th-randomness-revolution-drand-is-hiring">Join the Randomness Revolution: Drand is hiring!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/drand-v1.0-and-the-league-of-entropy-two-weeks-in">drand v1.0 and the League of Entropy: Two Weeks In</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/the-league-of-entropy-launches-drand">The League of Entropy launches drand v1.0 to become the Internet‚Äôs first production-grade, publicly verifiable, randomness beacon!</a></li></ul></div></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">drand on Filecoin Virtual Machine (FVM) - draffle</h1><div class="container_mt6G margin-vert--md"><time datetime="2023-03-15T00:00:00.000Z">March 15, 2023</time> ¬∑ <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a class="avatar__photo-link" href="/blog/authors/yolan"><img class="avatar__photo authorImage_XqGP" src="/img/author/yolan.jpeg" alt="Yolan Romailler"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="/blog/authors/yolan"><span class="authorName_yefp">Yolan Romailler</span></a></div><small class="authorTitle_nd0D" title="Co-Founder &amp; Cryptographer">Co-Founder &amp; Cryptographer</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>To mark the launch of user-programmable smart contracts on the Filecoin Virtual Machine (FVM), the drand team is excited to release a three-part blog series on using randomness on the FVM! In this first part, we dive into the prevrandao EVM opcode (the FVM fully supports EVM bytecode!), a sample Solidity contract using it, a UI to interact with it, and some other necessary plumbing to make it all work.</p>
<!-- -->
<p>If you want to skip all the wonderful learning, you can jump straight into the demo project we developed <a href="https://github.com/drand/draffle" target="_blank" rel="noopener noreferrer"><strong>on GitHub</strong></a> - the contract is deployed at address <code>0x9D38f3BB80D98cE09C3f0936Bea140181d4CCABA</code> on the Hyperspace testnet! A little familiarity with <a href="https://soliditylang.org/" target="_blank" rel="noopener noreferrer"><strong>Solidity</strong></a> will be helpful to follow along, but anyone familiar with a C-style language should be able to get the gist.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="-randomness-on-the-blockchain-Ô∏è">üé≤ <strong>Randomness on the Blockchain</strong> ‚õìÔ∏è<a href="#-randomness-on-the-blockchain-Ô∏è" class="hash-link" aria-label="Direct link to -randomness-on-the-blockchain-Ô∏è" title="Direct link to -randomness-on-the-blockchain-Ô∏è">‚Äã</a></h2>
<p>When developers think of randomness, we most often think of private randomness - for example, <a href="https://en.wikipedia.org/wiki/Cryptographically_secure_pseudorandom_number_generator" target="_blank" rel="noopener noreferrer"><strong>using a cryptographically secure pseudorandom number generator</strong></a> such as <a href="https://en.wikipedia.org/wiki//dev/random" target="_blank" rel="noopener noreferrer"><strong>/dev/random/</strong></a> to generate a private key. When executing a smart contract in a blockchain ecosystem, this poses a few challenges: Who provides the randomness? How do you know it&#x27;s random? If you interact with a smart contract, you can&#x27;t trust the author to generate randomness for you, as they may have a vested interest in the outcome. Similarly, you can&#x27;t trust miners to generate the randomness for you, as they too might have an interest in the outcome (or wish to collude with other participants).</p>
<hr>
<p>To be more concrete: <strong>Suppose I&#x27;m running a raffle via a smart contract</strong>, and users enter the draw by calling a function such as the following:</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin">address</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> entrants</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">external</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    entrants</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Everybody who submits a transaction (and has it mined) has their address added to the list of entrants, which will be &quot;randomly&quot; drawn from. As the <em>totally unbiased</em> author of the smart contract, I&#x27;ve provided another function that allows me to draw the randomly chosen participant:</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">event</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Winner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">address</span><span class="token plain"> theWinner</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">draw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint32</span><span class="token plain"> someTotallyRandomNumber</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">external</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">author </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Only the completely unbiased author can execute the draw winner!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// assuming we have set the `author` field in the constructor somewhere</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Winner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">entrants</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">someTotallyRandomNumber</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Of course, in blockchain-land, the state of the contract is public to everyone, and you as the author could simply register your own address as an entrant and pass in its index to win the raffle yourself!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-ethereum-increases-fairness"><strong>How Ethereum Increases Fairness</strong><a href="#how-ethereum-increases-fairness" class="hash-link" aria-label="Direct link to how-ethereum-increases-fairness" title="Direct link to how-ethereum-increases-fairness">‚Äã</a></h3>
<p>To address the challenges of randomness in smart contracts, the Ethereum community created <a href="https://github.com/randao/randao" target="_blank" rel="noopener noreferrer"><strong>RANDAO</strong></a>, a Decentralized Autonomous Organization (DAO) for providing randomness.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-randao-works"><strong>How RANDAO Works</strong><a href="#how-randao-works" class="hash-link" aria-label="Direct link to how-randao-works" title="Direct link to how-randao-works">‚Äã</a></h3>
<ol>
<li><strong>Contribution Phase</strong>:<!-- -->
<ul>
<li>In each block, 128 addresses from the network can contribute their piece of randomness.</li>
<li>Contributors send a small amount of ETH to the RANDAO contract along with a hash of their chosen random number.</li>
</ul>
</li>
<li><strong>Reveal Phase</strong>:<!-- -->
<ul>
<li>Six blocks later, contributors reveal their number.</li>
<li>Revealing the number earns them an ETH bounty.</li>
<li>Failing to reveal the number results in the loss of their deposited ETH.</li>
</ul>
</li>
<li><strong>Aggregation Phase</strong>:<!-- -->
<ul>
<li>Revealed numbers are combined to create a final random number.</li>
<li>This final random number is included in the block and is available to smart contracts in the next block using the prevrandao opcode.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="advantages-over-single-author-randomness"><strong>Advantages Over Single-Author Randomness</strong><a href="#advantages-over-single-author-randomness" class="hash-link" aria-label="Direct link to advantages-over-single-author-randomness" title="Direct link to advantages-over-single-author-randomness">‚Äã</a></h3>
<ol>
<li><strong>Verifiability</strong>:<!-- -->
<ul>
<li>Users can inspect the RANDAO contract state and see all the inputs combined to create the final random number.</li>
<li>This transparency attests to the method of construction and ensures fairness.</li>
</ul>
</li>
<li><strong>Reduced Bias</strong>:<!-- -->
<ul>
<li>Instead of relying on a single <em>totally unbiased</em> author, up to 128 parties are involved in creating the randomness.</li>
<li>This makes it much harder to influence the output, raising the bar for any potential bias.</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-challenges-and-limitations">‚õî <strong>Challenges and Limitations</strong><a href="#-challenges-and-limitations" class="hash-link" aria-label="Direct link to -challenges-and-limitations" title="Direct link to -challenges-and-limitations">‚Äã</a></h3>
<p>While RANDAO improves fairness, it is not entirely immune to manipulation. One such challenge is the &#x27;last mover&#x27;s advantage&#x27;:</p>
<ul>
<li><strong>Commit/Reveal Scheme</strong>: Participants commit to a random number ahead of time by providing the corresponding (SHA-3) hash. Later, they can choose to reveal or not reveal that number.</li>
<li><strong>Last Mover&#x27;s Advantage</strong>: The last participant to reveal their number can choose to reveal or not reveal it based on the desired outcome, thereby biasing the final output.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="illustrating-last-movers-advantage"><strong>Illustrating Last Mover&#x27;s Advantage</strong><a href="#illustrating-last-movers-advantage" class="hash-link" aria-label="Direct link to illustrating-last-movers-advantage" title="Direct link to illustrating-last-movers-advantage">‚Äã</a></h3>
<p>Imagine a scenario with 10 slots where each participant decides a single bit of the output number:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Number | 1 | 1 | 0 | 1 | 0 | 0 | 0 | 1 | 0 | ? |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Slot   | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Suppose the committed number is <code>1</code>.</li>
<li>The last participant can influence the final bit by deciding whether to reveal or not reveal their number.</li>
<li>For example, if a coin-flipping smart contract uses the last bit to determine heads (1) or tails (0), the last participant can ensure a desired outcome by revealing or not revealing their number.</li>
</ul>
<p>In practice, the influence is probabilistic and not direct. However, larger players who can fill more of the &#x27;slots&#x27; in RANDAO can still exert undue influence.</p>
<p>By involving multiple parties and ensuring transparency, RANDAO significantly enhances the fairness and reliability of randomness in smart contracts, despite its limitations.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="randao-on-fvm"><strong>RANDAO on FVM</strong><a href="#randao-on-fvm" class="hash-link" aria-label="Direct link to randao-on-fvm" title="Direct link to randao-on-fvm">‚Äã</a></h3>
<p>RANDAO on EVM is still great - the above is more an insight into some of the security assumptions around it, as a way of introducing FVM&#x27;s approach to RANDAO and contrasting it. As the FVM is EVM compatible (i.e., everything possible in EVM bytecode is also possible on the FVM), it must also provide a <code>prev_randao</code> opcode for use in smart contracts and compatibility purposes. Instead of bridging to Ethereum or running its own RANDAO (both of which could happen in the future), Filecoin already has its own source of randomness used for leader election: drand.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="refresher-of-how-drand-works"><strong>Refresher of how drand works</strong><a href="#refresher-of-how-drand-works" class="hash-link" aria-label="Direct link to refresher-of-how-drand-works" title="Direct link to refresher-of-how-drand-works">‚Äã</a></h3>
<ul>
<li><strong>Threshold Network</strong>: drand is a <a href="https://en.wikipedia.org/wiki/Threshold_cryptosystem" target="_blank" rel="noopener noreferrer"><strong>threshold network</strong></a> that provides publicly verifiable, unbiasable randomness. It exploits the fact that the hash of a signature is indistinguishable from randomness to people without the associated private key.</li>
<li><strong>Cooperative Action</strong>: A threshold network is a network of nodes that can cooperatively perform actions such as signing. Enough nodes need to work together (referred to as the &#x27;threshold&#x27;) to perform these actions.</li>
<li><strong>Shamir&#x27;s Secret Sharing</strong>: Using a form of <a href="https://en.wikipedia.org/wiki/Shamir%27s_secret_sharing" target="_blank" rel="noopener noreferrer"><strong>Shamir&#x27;s Secret Sharing</strong></a>, the network creates a cryptographic keypair that no single member of the group has the private key of. Instead, they each get a share of that private key and must aggregate a threshold number of signatures to create a full signature on behalf of the entire group.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="key-features-of-drand"><strong>Key Features of drand</strong><a href="#key-features-of-drand" class="hash-link" aria-label="Direct link to key-features-of-drand" title="Direct link to key-features-of-drand">‚Äã</a></h3>
<ul>
<li><strong>Unbiasable Randomness</strong>: Unlike RANDAO, nodes in drand cannot influence the final random output. Once the keypair is generated, all future random numbers are deterministically decided, but nobody can get them until they&#x27;ve received a threshold number of signatures for each number.</li>
<li><strong>Security Considerations</strong>: One drawback is that if a threshold number of nodes were compromised, all future random numbers could be derived.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="drand-in-filecoin"><strong>drand in Filecoin</strong><a href="#drand-in-filecoin" class="hash-link" aria-label="Direct link to drand-in-filecoin" title="Direct link to drand-in-filecoin">‚Äã</a></h3>
<ul>
<li><strong>Inclusion in Blocks</strong>: In Filecoin, the drand randomness beacon for the current time is included in every block&#x27;s headers.</li>
<li><strong>Usage in Smart Contracts</strong>: When a contract calls the <code>prevrandao</code> opcode, the randomness from the previous block is provided to it. This offers a straightforward method of using randomness on-chain, though with some potential pitfalls to consider.</li>
</ul>
<hr>
<p>Okay - without further ado let&#x27;s jump into the web app and code!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-ui">The UI<a href="#the-ui" class="hash-link" aria-label="Direct link to The UI" title="Direct link to The UI">‚Äã</a></h2>
<p>When the user first opens the UI, they should see something like this:</p>
<p><img decoding="async" loading="lazy" alt="https://drand.love/assets/img/start.bdca1319.png" src="/assets/images/start.bdca1319-5b6ec8b47e6a2be361d8b5ebd73a236f.png" width="2048" height="1042" class="img_ev3q"></p>
<p>On the left-hand side we see when the next draw is scheduled, the current block and any draws that have already happened. There‚Äôs also a button labelled ‚ÄòEnter the next draw‚Äô that we can click to pay the entry fee via our Metamask wallet. When we click it, a popup from Metamask such as the following appears:</p>
<p><img decoding="async" loading="lazy" alt="https://drand.love/assets/img/connect-wallet.083095e5.png" src="/assets/images/connect-wallet.083095e5-f1603df1091b63db423dd7e7245fe794.png" width="712" height="1394" class="img_ev3q"></p>
<p>Once we‚Äôve confirmed the transaction, we‚Äôve now entered the draw:</p>
<p><img decoding="async" loading="lazy" alt="https://drand.love/assets/img/draw-accepted.2ff1aab6.png" src="/assets/images/draw-accepted.2ff1aab6-d1598b7ac9596149bffc8764498031e8.png" width="2048" height="1043" class="img_ev3q"></p>
<p>If you‚Äôre on hyperspace, we can wait up to 24 hours (the default) until the next draw is scheduled, and we will be able to trigger it (in the next section we‚Äôll find how to reduce that to any time we want for easier testing). At the time of the draw, the right-hand side of the UI will have changed:</p>
<p><img decoding="async" loading="lazy" alt="https://drand.love/assets/img/trigger-draw.4356efc5.png" src="/assets/images/trigger-draw.4356efc5-9cf48c8285526c36ea5093aec44344c0.png" width="2048" height="1049" class="img_ev3q"></p>
<p>At the draw block height, users will be able to compete to trigger the draw and receive a small payout. Once the draw has been triggered, a new one is scheduled:</p>
<p><img decoding="async" loading="lazy" alt="https://drand.love/assets/img/draw-triggered.ac101ff4.png" src="/assets/images/draw-triggered.ac101ff4-f2804b448884e9c64783c4af3f3a0724.png" width="2048" height="1049" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-contract">The Contract<a href="#the-contract" class="hash-link" aria-label="Direct link to The Contract" title="Direct link to The Contract">‚Äã</a></h2>
<p>First off, in the <code>./contracts/</code> directory, we have a single file called <a href="https://drand.love/blog/2023/03/16/draffle/contracts/DRaffle.sol" target="_blank" rel="noopener noreferrer"><strong>DRaffle.sol</strong></a>. It contains the solidity code which will be run on FVM to manage all the entrants and payouts from the contest. Let&#x27;s take a look at its constructor and fields:</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">solidityCopy code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> costPerDraw</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> drawCutoff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> triggerReward</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> nextDrawBlockHeight</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin">address</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> candidates</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint256</span><span class="token plain"> roundCutoff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> cost</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> reward</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    costPerDraw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cost</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    triggerReward </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> reward</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    drawCutoff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> roundCutoff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">scheduleNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>The first field set in the constructor enables the author of the contract to choose a <code>cost</code> of entry (in FIL). All entrants will pay it, and (nearly all of) the total pool for every draw will be paid out to the winning address.</li>
<li>The second field set is a <code>reward</code> for users who initiate the draw. As the contract runs on-chain, we can&#x27;t easily (in solidity anyway) schedule future draws automagically - we have to rely on somebody in the ecosystem submitting a transaction to trigger the draw. To incentivise that, we&#x27;ll provide a small FIL bounty to cover the transaction fee plus a little extra, so users will want to trigger the draw.</li>
<li>The final field set - <code>drawCutOff</code> - is the number of blocks in advance we wish to close entries for a given draw. Readers with a keen eye will have noticed in the explanation of the <code>prevrandao</code> instruction, that it returns the randomness from the <em>previous</em> block header, and not the current block. Entrants could therefore know the random number used for a draw in advance of the draw happening.<!-- -->
<ul>
<li><em>In follow-up blog posts, we&#x27;ll discuss how we can use more current randomness to avoid this pitfall, but for now let&#x27;s close draws a few blocks in advance to eliminate this possibility of gaming the draw.</em></li>
</ul>
</li>
<li>Finally the constructor calls the <code>scheduleNext</code> function which will set the <code>nextDrawBlockHeight</code> field, clear any candidates and emit some convenient events for the UI to consume. It&#x27;s implementation is as follows:</li>
</ul>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">solidityCopy code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">scheduleNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">internal</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    candidates </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">address</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    nextDrawBlockHeight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> block</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2880</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Scheduled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nextDrawBlockHeight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With this implementation a draw will happen once every 24 hours (Filecoin mines a block every 30 seconds, i.e. 2 per minute, 60 minutes per hour, 24 hours per day- 2 * 60 * 24 = 2880), but it can easily be configured to be more frequent.</p>
<p>Now to our function users will call to enter the draw:</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">solidityCopy code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">external</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">payable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> costPerDraw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;you have passed too much or too little money to enter the lotto&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> nextDrawBlockHeight </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> drawCutoff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;It&#x27;s too close to the next draw to participate&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    candidates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It&#x27;s quite simple: users must pass a token amount equal to the <code>costPerDraw</code> into the contract with their transaction (hence the <code>payable</code> keyword). If they correctly do that and it&#x27;s not too close to the draw (remembering our <code>prevrandao</code> limitation discussed above!), their address is added to the candidate list for the draw.</p>
<p>The final important function is the draw function itself:</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">solidityCopy code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">draw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">external</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">payable</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// first we ensure that users can&#x27;t trigger the draw too early</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// we let them draw late, because perhaps nobody could get a transaction mined for the exact block height!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> nextDrawBlockHeight</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;it&#x27;s too early to trigger the draw!&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// if nobody entered the draw, and thus there is no money to pay out, we send an event that there was no winner and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// just schedule the next draw</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">uint</span><span class="token plain"> numberOfEntries </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> candidates</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">numberOfEntries </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NoWinner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// if there are candidates for the draw, we use the `prevrandao` value from the block, and turn it into an index to choose the winner.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// note: using the modulo operation can result in an output bias - check this great blog post on the matter: &lt;https://research.kudelskisecurity.com/2020/07/28/the-definitive-guide-to-modulo-bias-and-how-to-avoid-it/&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">address</span><span class="token plain"> winner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> candidates</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prevrandao </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> numberOfEntries</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">uint256</span><span class="token plain"> amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> numberOfEntries </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> costPerDraw </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> triggerReward</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// we pay out the chosen winner</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">payable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">winner</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">amount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// and also pay out the `triggerReward` to the address who triggered the draw successfully</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// a small point to note is that they won&#x27;t get paid out if there are no entrants...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// paying them out would require the contract to maintain its own balance of tokens to pay out</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// raffles with no entries, so it&#x27;s been omitted for convenience, but it&#x27;s something to consider if you</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// decide to run your own raffle!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">payable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">triggerReward</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// and emit an event to let any listeners know who won!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">emit</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Winner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">block</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">number</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> winner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// finally, regardless of whether there is a winner or not we want to schedule the next draw as we saw in the constructor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">scheduleNext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So that&#x27;s it for part 1 - how to run a raffle using drand on the FVM via solidity. The sample repository contains a lot more useful tooling for deploying your own smart contract to the <a href="https://hyperspace.yoga/" target="_blank" rel="noopener noreferrer"><strong>Hyperspace testnet</strong></a> or your own local <a href="https://trufflesuite.com/ganache/" target="_blank" rel="noopener noreferrer"><strong>ganache network</strong></a>. In our next post, we&#x27;ll discuss how to use more immediate randomness functionality specific to the FVM, stepping outside the bounds of EVM compatibility.</p>
<p>Until then you can find the team on both the <a href="https://filecoin.io/slack" target="_blank" rel="noopener noreferrer"><strong>Filecoin slack</strong></a> and our own <a href="https://join.slack.com/t/drandworkspace/shared_invite/zt-19u4rf6if-bf7lxIvF2zYn4~TrBwfkiA" target="_blank" rel="noopener noreferrer"><strong>drand slack</strong></a> should you have any questions. Enjoy deploying cool projects to the FVM, and let us know how you&#x27;ve been using the FVM and randomness!</p>
<hr></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a title="fvm tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/fvm">FVM</a></li><li class="tag_QGVx"><a title="begginer tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/features">Features</a></li><li class="tag_QGVx"><a title="how to tag" class="tag_zVej tagRegular_sFm0" href="/blog/tags/how-to">How-to</a></li></ul></div></div><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><a href="https://github.com/drand/drand-docs/tree/master/blog/2023-03-15-drand-on-filecoin-virtual-machine-fvm-draffle.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/timelock-encryption-is-now-supported-on-drand-mainnet"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">Timelock Encryption is now supported on drand mainnet</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/auttomata-network-joins-the-league-of-entropy"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Automata Network Joins the League of Entropy!</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#-randomness-on-the-blockchain-Ô∏è" class="table-of-contents__link toc-highlight">üé≤ <strong>Randomness on the Blockchain</strong> ‚õìÔ∏è</a><ul><li><a href="#how-ethereum-increases-fairness" class="table-of-contents__link toc-highlight"><strong>How Ethereum Increases Fairness</strong></a></li><li><a href="#how-randao-works" class="table-of-contents__link toc-highlight"><strong>How RANDAO Works</strong></a></li><li><a href="#advantages-over-single-author-randomness" class="table-of-contents__link toc-highlight"><strong>Advantages Over Single-Author Randomness</strong></a></li><li><a href="#-challenges-and-limitations" class="table-of-contents__link toc-highlight">‚õî <strong>Challenges and Limitations</strong></a></li><li><a href="#illustrating-last-movers-advantage" class="table-of-contents__link toc-highlight"><strong>Illustrating Last Mover&#39;s Advantage</strong></a></li><li><a href="#randao-on-fvm" class="table-of-contents__link toc-highlight"><strong>RANDAO on FVM</strong></a></li><li><a href="#refresher-of-how-drand-works" class="table-of-contents__link toc-highlight"><strong>Refresher of how drand works</strong></a></li><li><a href="#key-features-of-drand" class="table-of-contents__link toc-highlight"><strong>Key Features of drand</strong></a></li><li><a href="#drand-in-filecoin" class="table-of-contents__link toc-highlight"><strong>drand in Filecoin</strong></a></li></ul></li><li><a href="#the-ui" class="table-of-contents__link toc-highlight">The UI</a></li><li><a href="#the-contract" class="table-of-contents__link toc-highlight">The Contract</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/home">Dev Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/drand" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/drandworkspace/shared_invite/zt-2p00bn43o-qALTK5RZEIK3I4fIO9h8dQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/drand/drand" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Apache 2.0 and/or MIT Licensed 2024 Randamu, Inc.‚Ñ¢ Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>