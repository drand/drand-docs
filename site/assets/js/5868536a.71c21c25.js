"use strict";(self.webpackChunkdrand_docs=self.webpackChunkdrand_docs||[]).push([[3889],{1032:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>a,toc:()=>h});var s=t(4848),i=t(8453);const r={slug:"observing-randomness",title:"Observing Randomness",authors:["yolan"],tags:["features"],date:new Date("2022-08-25T00:00:00.000Z")},o=void 0,a={permalink:"/blog/observing-randomness",editUrl:"https://github.com/drand/drand-docs/tree/master/blog/2022-08-25-observing-randomness.mdx",source:"@site/blog/2022-08-25-observing-randomness.mdx",title:"Observing Randomness",description:"Monitoring distributed systems is a challenge. While there are established patterns and solutions for monitoring the most common types of applications, there is usually no silver bullet. In this blog post, we outline the challenges that we faced when implementing monitoring for one such system, drand.",date:"2022-08-25T00:00:00.000Z",tags:[{inline:!1,label:"Features",permalink:"/blog/tags/features",description:"begginer tag"}],readingTime:5.486666666666666,hasTruncateMarker:!0,authors:[{name:"Yolan Romailler",title:"Co-Founder & Cryptographer",description:"Applied cryptographer with a leaning for broader security/vulnerability research. \n\nWorked on the Distributed Randomness project, drand, at Protocol Labs and also on CBDC and SSI at SICPA, as well as broader cryptographic engineering at Kudelski Security. I've also been a Security Engineer on the Diem security team for Novi (Facebook/Meta).\nA subject matter expert in secure coding. As a consultant, I've supported customers by answering complex questions on security critical systems such as blockchain technologies, and by designing, evaluating and implementing complex cryptography such as key management systems or cryptographic primitives.\n",page:{permalink:"/blog/authors/yolan"},imageURL:"/img/author/yolan.jpeg",key:"yolan"}],frontMatter:{slug:"observing-randomness",title:"Observing Randomness",authors:["yolan"],tags:["features"],date:"2022-08-25T00:00:00.000Z"},unlisted:!1,prevItem:{title:"CryptoSat takes drand to Space!",permalink:"/blog/cryptosat-takes-drand-to-space"},nextItem:{title:"drand @ NorthSec",permalink:"/blog/drand-at-northsec"}},d={authorsImageUrls:[void 0]},h=[{value:"What is drand?",id:"what-is-drand",level:3},{value:"\ud83d\udcc8 The Need for Monitoring",id:"-the-need-for-monitoring",level:3},{value:"\ud83d\udccf Monitoring Architecture Requirements",id:"-monitoring-architecture-requirements",level:3},{value:"\ud83d\udcd0 Design Decisions",id:"-design-decisions",level:3},{value:"\ud83d\udcca Metrics Design",id:"-metrics-design",level:3},{value:"\ud83d\udce1 Inter-Node Communications",id:"-inter-node-communications",level:3},{value:"\ud83d\udcc9 Dashboard Design",id:"-dashboard-design",level:3},{value:"\ud83c\udfc6 Results",id:"-results",level:3},{value:"Next Steps",id:"next-steps",level:3},{value:"Suggested References for Further Reading:",id:"suggested-references-for-further-reading",level:3}];function l(e){const n={a:"a",code:"code",em:"em",h3:"h3",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"Monitoring distributed systems is a challenge. While there are established patterns and solutions for monitoring the most common types of applications, there is usually no silver bullet. In this blog post, we outline the challenges that we faced when implementing monitoring for one such system, drand."})}),"\n","\n",(0,s.jsx)(n.h3,{id:"what-is-drand",children:"What is drand?"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Drand"})," is a public, verifiable, unpredictable, and unbiased randomness beacon. It is based on the idea that to generate randomness in a reliable and trustworthy way, you cannot depend on a single entity to control the infrastructure where it runs. This led us to seek the collaboration of multiple organizations to run their own drand daemons, forming ",(0,s.jsx)(n.a,{href:"https://drand.love/1e76674b75e249699445799c5083fe78",children:"The League of Entropy"})," (LoE)\u2014a distributed organization where each participating partner runs a drand node."]}),"\n",(0,s.jsxs)(n.p,{children:["A drand ",(0,s.jsx)(n.em,{children:"network"})," is composed of multiple ",(0,s.jsx)(n.em,{children:"nodes"}),". Each network generates separate randomness beacons at specific intervals, called ",(0,s.jsx)(n.em,{children:"rounds"}),". The number of nodes on a network is fixed at any given point in time and only changes during a ",(0,s.jsx)(n.em,{children:"ceremony"}),". During the ceremony, a ",(0,s.jsx)(n.em,{children:"threshold"})," is set, which is the minimum number of nodes that need to be connected to the network at any given time for randomness generation to succeed."]}),"\n",(0,s.jsx)(n.h3,{id:"-the-need-for-monitoring",children:"\ud83d\udcc8 The Need for Monitoring"}),"\n",(0,s.jsx)(n.p,{children:"To ensure security, we do not allow just any host to join the network at any time. Whenever a host joins or leaves the network, we hold a \u201cceremony\u201d where cryptographic keys are refreshed and exchanged. In between ceremonies, the list of hosts that participate in a drand network is static. Ceremonies are usually held quarterly, and before each ceremony, an allow list containing the IP addresses of all nodes in the network is distributed to all participants to open the appropriate firewall ports."}),"\n",(0,s.jsx)(n.p,{children:"Coordinating these ceremonies presents several challenges:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Synchronous Operation"}),": All node operators need to be online simultaneously to execute commands correctly."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Version Mismatch"}),": Nodes might be running different versions of ",(0,s.jsx)(n.code,{children:"drand"}),", leading to failures."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Connectivity Issues"}),": Nodes might have connectivity problems that prevent proper participation."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["To address these issues, full visibility into the drand network and the state of each node is essential. Our goal is to enable ",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Asynchronous_system",children:(0,s.jsx)(n.strong,{children:"asynchronous ceremonies"})})," where operators can execute commands within a timeframe without being online simultaneously. A monitoring tool providing an accurate view of nodes and network states is necessary."]}),"\n",(0,s.jsx)(n.h3,{id:"-monitoring-architecture-requirements",children:"\ud83d\udccf Monitoring Architecture Requirements"}),"\n",(0,s.jsx)(n.p,{children:"To properly monitor the drand network, we have the following requirements:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Allow any LoE member to create their own monitoring infrastructure"}),": Organizations can select the metrics aggregation platform that best meets their needs."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Ease of deployment"}),": Modify the drand binary to export metrics without adding a new binary."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Minimize the need for opening network ports"}),": Ideally, no network ports other than the one used for generating randomness should be opened."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use industry-standard formats where possible"}),": Use an industry-standard format to publish metrics."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Ability to see the state of the whole network from any point in the network"}),": Enable each node to provide a full view of the whole network."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"(Close to) real-time view of the network state"}),": Ensure changes in node state are seen quickly, especially during ceremonies."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-design-decisions",children:"\ud83d\udcd0 Design Decisions"}),"\n",(0,s.jsx)(n.p,{children:"Our requirements led to the following design:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Each node exposes its own metrics in Prometheus format"}),": Prometheus is an ",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Prometheus_(software)",children:(0,s.jsx)(n.strong,{children:"industry-standard"})})," format, and each node exposing its own metrics allows direct monitoring of individual nodes."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Each node can retrieve other nodes\u2019 metrics and expose them in Prometheus format"}),": This enables not only Protocol Labs but any LoE member to create their own dashboards showing the state of the whole network."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Metrics transport uses the same mechanism as inter-node communication for generating randomness (GRPC)"}),": By using ",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/GRPC",children:(0,s.jsx)(n.strong,{children:"GRPC"})}),", we allow metrics to be sent between nodes without requiring additional network ports."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Gather metrics using Telegraf and export them to InfluxDB, accessed via Grafana Cloud"}),": This setup centralizes metrics and creates an easy-to-use dashboard with a one-minute scraping interval, which can be lowered during ceremonies for faster updates."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-metrics-design",children:"\ud83d\udcca Metrics Design"}),"\n",(0,s.jsx)(n.p,{children:"We decided to monitor the following minimal information for running a smooth ceremony:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Version of ",(0,s.jsx)(n.code,{children:"drand"})," that the node is running."]}),"\n",(0,s.jsx)(n.li,{children:"Whether nodes have restarted their daemon ahead of the ceremony to ensure that the certificate is still valid and to clear the process\u2019 memory and storage."}),"\n",(0,s.jsx)(n.li,{children:"Whether nodes have connectivity to all other nodes."}),"\n",(0,s.jsx)(n.li,{children:"The current ceremony state of the node."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"For ongoing monitoring, we added the following for each beacon in each node:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"When the last randomness was generated."}),"\n",(0,s.jsx)(n.li,{children:"The last round generated by the node for that beacon chain."}),"\n",(0,s.jsx)(n.li,{children:"The time difference between nodes (including network round-trip times)."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-inter-node-communications",children:"\ud83d\udce1 Inter-Node Communications"}),"\n",(0,s.jsxs)(n.p,{children:["As mentioned above, one of the requirements was to be able to view the state of the whole drand network without requiring node operators to open any additional holes in their firewall, nor to connect to any hosts other than those included in the drand network itself. Therefore, it was necessary to enable the possibility of fetching a remote node\u2019s metrics via the same method used to coordinate randomness generation: that is, through ",(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/GRPC",children:(0,s.jsx)(n.strong,{children:"GRPC"})}),"."]}),"\n",(0,s.jsx)(n.p,{children:"We also wanted to reduce the amount of metrics traffic between nodes, so we went with a pull system where any node can pull any other node\u2019s metrics when requested. For that, we exposed an additional HTTP endpoint that includes the peer\u2019s ID to get Prometheus metrics for the associated peer. A request to that endpoint makes a GRPC call to the remote node to get the metrics before returning them to the client. With this, we have the ability to get metrics from all nodes in the drand network without any unnecessary additional traffic."}),"\n",(0,s.jsxs)(n.p,{children:["The Protocol Labs nodes all run instances of ",(0,s.jsx)(n.a,{href:"https://www.influxdata.com/time-series-platform/telegraf/",children:(0,s.jsx)(n.strong,{children:"Telegraf"})}),", whose configuration is hard-coded to get the metrics from all nodes in the drand network. This is possible because the nodes in the network are static and only change during ceremonies. Telegraf then pushes the metrics into ",(0,s.jsx)(n.a,{href:"https://www.influxdata.com/",children:(0,s.jsx)(n.strong,{children:"InfluxDB"})}),". We then use ",(0,s.jsx)(n.a,{href:"https://grafana.com/",children:(0,s.jsx)(n.strong,{children:"Grafana"})})," to visualize the data."]}),"\n",(0,s.jsx)(n.p,{children:"Regarding LoE members, the fact that metrics are exposed using the industry-standard Prometheus format and that any node can gather metrics from any other node in the network makes it possible for any of them to create a setup similar to this and gather metrics into their own observability solution."}),"\n",(0,s.jsx)(n.h3,{id:"-dashboard-design",children:"\ud83d\udcc9 Dashboard Design"}),"\n",(0,s.jsx)(n.p,{children:"As is usually the case, it took multiple iterations to get to a dashboard design that was useful and also comprehensible. These iterations involved both changing the layout and organization of the presented information, as well as adding metrics that were missed during initial analysis. For example, during ceremonies some of the state changes happen so fast that they were missed by the polling and dashboard refresh intervals, so we added timestamps to be able to see whether a state had changed or not. We also reformulated some metrics labels to reduce cardinality."}),"\n",(0,s.jsx)(n.p,{children:"We ended up with a dashboard with two sections. The first section includes connectivity information for each node, as well as a connectivity matrix showing which nodes are connected to which other nodes. This has enabled us to find problems such as firewall misconfigurations or bugs impacting connectivity."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"https://drand.love/assets/img/drand_dash_1.f1a0b363.png",src:t(9287).A+"",width:"1175",height:"887"})}),"\n",(0,s.jsx)(n.p,{children:"The second section contains information about each of the beacons in the given network, including the ceremony state for each node. This allows us to track ceremonies, as well as ensuring that all nodes are up to date with all other nodes."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"https://drand.love/assets/img/drand_dash_2.f887bda3.png",src:t(9733).A+"",width:"1158",height:"845"})}),"\n",(0,s.jsx)(n.h3,{id:"-results",children:"\ud83c\udfc6 Results"}),"\n",(0,s.jsx)(n.p,{children:"We have already deployed and used the new dashboard in the last set of ceremonies that we carried out in our testnet network. It has proven to be an extremely useful tool. We were able to spot connectivity problems and other inconsistencies in a totally asynchronous manner, which in turn enabled us to resolve issues much faster. This has given us confidence to run the next testnet ceremony in an asynchronous manner, without having to coordinate all operators being in front of their keyboards at the same time."}),"\n",(0,s.jsx)(n.p,{children:"Beyond ceremonies, we now have a much more detailed view of the state of the LoE drand network."}),"\n",(0,s.jsx)(n.h3,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsx)(n.p,{children:"As is the case with pretty much any software tool, many more features can be added and several of the existing ones can be optimized. However, what we have is already a big step forward and gives us much higher confidence in the process, compared to the ceremony procedure we used to have."}),"\n",(0,s.jsx)(n.p,{children:"Some of the issues we have found that we would like to fix in future versions of the monitoring infrastructure are:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Consistency"}),": We sometimes see some measurements toggling between two numbers in the dashboard. The reason for this is, we are gathering metrics from all hosts and storing them in Influx DB. However, some of these metrics are system-wide, and since this is a distributed system, some hosts might have slightly different views of the state of the network than other hosts (especially during ceremonies). While this is not a widespread problem, it can be confusing."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Visibility of New Nodes"}),": When a new node joins the network, we are unable to see"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"it in the dashboard until the ceremony is finished. We would like to have some way of monitoring the state of a new node."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Visibility in the Case of Connectivity Problems"}),": Since we are scraping the metrics from the Protocol Labs nodes, if a node cannot connect to any of them, we cannot gather its metrics. While this is mitigated by scraping from all Protocol Labs nodes instead of just one, we still run the risk of missing a node\u2019s metrics if it cannot connect to any Protocol Labs nodes."]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h3,{id:"suggested-references-for-further-reading",children:"Suggested References for Further Reading:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Random_number",children:"Random Number"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Threshold_cryptography",children:"Threshold Cryptography"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Public_key_infrastructure",children:"Public Key Infrastructure"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Verifiable_random_function",children:"Verifiable Random Function"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Prometheus_(software)",children:"Prometheus (software)"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/GRPC",children:"GRPC"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Asynchronous_system",children:"Asynchronous System"})}),"\n"]}),"\n",(0,s.jsx)(n.hr,{})]})}function c(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},9287:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/drand_dash_1.f1a0b363-d91d74ddbe74f78ea8c2c3da60e99c2d.png"},9733:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/drand_dash_2.f887bda3-0f1d726e291be5d74b2fa9879db8b50a.png"},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var s=t(6540);const i={},r=s.createContext(i);function o(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);