"use strict";(self.webpackChunkdrand_docs=self.webpackChunkdrand_docs||[]).push([[5377],{9065:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>i,default:()=>c,frontMatter:()=>s,metadata:()=>a,toc:()=>l});var r=n(4848),o=n(8453);const s={slug:"retro-on-the-drand-testnet",title:"Retro on the drand testnet outage of Feb 21, 2024",authors:[],tags:["news","postmortem","ceremony"]},i=void 0,a={permalink:"/blog/retro-on-the-drand-testnet",editUrl:"https://github.com/drand/drand-docs/tree/master/blog/2024-02-22-Retro-on-the-drand-testnet-outage-offeb-21-2024.md",source:"@site/blog/2024-02-22-Retro-on-the-drand-testnet-outage-offeb-21-2024.md",title:"Retro on the drand testnet outage of Feb 21, 2024",description:"TL;DR",date:"2024-02-22T00:00:00.000Z",tags:[{inline:!1,label:"News",permalink:"/blog/tags/news",description:"news tag"},{inline:!1,label:"Postmortem",permalink:"/blog/tags/postmortem",description:"postmortem tag"},{inline:!1,label:"Ceremony",permalink:"/blog/tags/ceremony",description:"ceremony tag"}],readingTime:5.905,hasTruncateMarker:!1,authors:[],frontMatter:{slug:"retro-on-the-drand-testnet",title:"Retro on the drand testnet outage of Feb 21, 2024",authors:[],tags:["news","postmortem","ceremony"]},unlisted:!1,prevItem:{title:"Creating a Notion Widget to display the latest Public Randomness from drand!",permalink:"/blog/create-a-notion-widget"},nextItem:{title:"quicknet is live on League of Entropy mainnet",permalink:"/blog/quicknet-is-live-on-league-of-entrophy-mainnet"}},d={authorsImageUrls:[]},l=[{value:"<strong>TL;DR</strong>",id:"tldr",level:2},{value:"Background",id:"background",level:2},{value:"<strong>Prior to the Ceremony</strong>",id:"prior-to-the-ceremony",level:3},{value:"<strong>The Update Before the Ceremony</strong>",id:"the-update-before-the-ceremony",level:3},{value:"<strong>The Ceremony</strong>",id:"the-ceremony",level:3},{value:"<strong>Next Steps</strong>",id:"next-steps",level:3},{value:"<strong>Final Thoughts</strong>",id:"final-thoughts",level:3}];function h(e){const t={code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h2,{id:"tldr",children:(0,r.jsx)(t.strong,{children:"TL;DR"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Testnet fell behind for 45 minutes."}),"\n",(0,r.jsx)(t.li,{children:"The ceremony was aborted."}),"\n",(0,r.jsx)(t.li,{children:"Fallback to non-TLS on some nodes caused the network to fall behind."}),"\n",(0,r.jsx)(t.li,{children:"Bugs in migration paths and the state machine blocked the ceremony."}),"\n",(0,r.jsx)(t.li,{children:"We will re-run the ceremony asynchronously."}),"\n",(0,r.jsx)(t.li,{children:"Testnet has regained stability and is operating normally."}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"background",children:"Background"}),"\n",(0,r.jsxs)(t.p,{children:["On February 21, 2024, we had to abort our v2.0.2-testnet ceremony after encountering a series of bugs. The ",(0,r.jsx)(t.code,{children:"default"}),", ",(0,r.jsx)(t.code,{children:"testnet-g"}),", and ",(0,r.jsx)(t.code,{children:"testnet-unchained-3s"})," networks were down for about 45 minutes, while ",(0,r.jsx)(t.code,{children:"quicknet-t"})," remained relatively stable."]}),"\n",(0,r.jsx)(t.p,{children:"While it felt like a disaster, this is precisely why we have a testnet. It's better to face issues here than risk the 100% uptime of the mainnet!"}),"\n",(0,r.jsx)(t.h3,{id:"prior-to-the-ceremony",children:(0,r.jsx)(t.strong,{children:"Prior to the Ceremony"})}),"\n",(0,r.jsxs)(t.p,{children:["We'll focus on the ",(0,r.jsx)(t.code,{children:"default"})," network for the remainder of this post-mortem, though the issues generally applied to the other networks as well. The prior ",(0,r.jsx)(t.code,{children:"default"})," ceremony was in May 2023, nearly a year before this incident. In that ceremony, 12 nodes participated, with a threshold of 7. Due to known, non-deterministic issues in the codebase, 2 nodes failed to complete the distributed key generation. This left the network with 10 operational nodes."]}),"\n",(0,r.jsxs)(t.p,{children:["In a previous testnet upgrade (for ",(0,r.jsx)(t.code,{children:"quicknet-t"})," on January 10, 2024), the network upgraded to v2.0.0-testnet. Due to API incompatibilities, nodes on this version couldn't connect to nodes older than v1.5.7. cLabs did not participate in this ceremony and failed to upgrade their node since, causing a fork from the rest of the network, leaving the default network with 9 operational nodes."]}),"\n",(0,r.jsxs)(t.p,{children:["In preparation for the same ceremony, a new member of Ken Labs accidentally overwrote their ",(0,r.jsx)(t.code,{children:"default"})," keypair with an erroneous command. We've since published a fix to prevent this. Coupled with reverse proxy issues, the Ken Labs node became inoperative, reducing the ",(0,r.jsx)(t.code,{children:"default"})," network to 8 operational nodes\u2014just 1 above the threshold and at risk of halting."]}),"\n",(0,r.jsx)(t.h3,{id:"the-update-before-the-ceremony",children:(0,r.jsx)(t.strong,{children:"The Update Before the Ceremony"})}),"\n",(0,r.jsx)(t.p,{children:"Protocol Labs updated their nodes to v2.0.2-testnet first, and initially, everything looked fine."}),"\n",(0,r.jsxs)(t.p,{children:["IPFS Force soon reported issues starting their node due to a missing ",(0,r.jsx)(t.code,{children:"SchemeName"})," when loading their key pair. They hadn't upgraded their node sequentially to v2.0.2-testnet, so their keys didn't contain all the correct fields. We quickly published v2.0.3-testnet, which included a simple patch, allowing IPFS Force to upgrade and start their node successfully."]}),"\n",(0,r.jsxs)(t.p,{children:["As others started upgrading, we saw an uptick in ",(0,r.jsx)(t.code,{children:"http2: frame too large"})," messages when connecting to some nodes, reported by Automata Network. Knowing Automata Network uses an nginx reverse proxy, we assumed it was related to misconfigured nginx gRPC proxies. We debugged with Automata Network, restarted the nodes, and the error disappeared temporarily."]}),"\n",(0,r.jsxs)(t.p,{children:["As more nodes updated, they reported similar errors, and restarts no longer resolved the issues. Additionally, the ",(0,r.jsx)(t.code,{children:"http2: frame too large"})," error inconsistently affected different nodes. Automata and QRL also reported ",(0,r.jsx)(t.code,{children:"error reading server preface: EOF"})," when connecting to PL nodes."]}),"\n",(0,r.jsx)(t.p,{children:"The network stopped aggregating beacons as usual due to these connectivity issues. Periodic aggregations occurred, but not fast enough to catch up."}),"\n",(0,r.jsxs)(t.p,{children:["While debugging and assisting DIA data, we found their node had joined ",(0,r.jsx)(t.code,{children:"quicknet-t"})," with the ",(0,r.jsx)(t.code,{children:"TLS"})," field set to false. In v2.0.2-testnet, we removed TLS termination from the drand binary, expecting members to handle TLS via a reverse proxy. Our nodes connected to DIA over plaintext, which was unexpected but not a security issue (everything in drand is signed and verified)."]}),"\n",(0,r.jsxs)(t.p,{children:["This fallback to non-TLS connections explained the errors we saw. QRL logs confirmed their node dropped to non-TLS connections, causing the ",(0,r.jsx)(t.code,{children:"http2: frame too large"})," and ",(0,r.jsx)(t.code,{children:"error reading server preface: EOF"})," errors. We quickly shipped patch v2.0.4-testnet, and as nodes updated, the network began to recover."]}),"\n",(0,r.jsx)(t.h3,{id:"the-ceremony",children:(0,r.jsx)(t.strong,{children:"The Ceremony"})}),"\n",(0,r.jsx)(t.p,{children:"After allowing the network to catch up, we proceeded with the leader's ceremony instructions but encountered an error."}),"\n",(0,r.jsx)(t.p,{children:"During the first load of a daemon on v2.x after a v1.5.x ceremony, the group file migrates into the DKG database. This worked as expected, but a change in our signature scheme required fetching new signatures for participating nodes. An oversight caused even the keys for nodes leaving the network to attempt to fetch, leading to failures in generating a valid proposal."}),"\n",(0,r.jsx)(t.p,{children:"To avoid further updates, we deployed a patched version to our leader node and generated a proposal successfully."}),"\n",(0,r.jsx)(t.p,{children:"With the patched version, we initiated the resharing on the leader node but encountered an invalid packet signature error. Another node received our packet, attempted to gossip it, and the signature was deemed invalid. Despite our DKG database reporting a successful proposal, we were unsure of other nodes' states."}),"\n",(0,r.jsx)(t.p,{children:"Facing time pressure, we decided to abort the DKG and retry. The leader can issue aborts unilaterally, and this packet gossiped without issue."}),"\n",(0,r.jsxs)(t.p,{children:["In hindsight, we should have asked other LoE members for their ",(0,r.jsx)(t.code,{children:"drand dkg status"})," output to confirm receipt of the proposal. If all had received it, we could have continued the resharing."]}),"\n",(0,r.jsx)(t.p,{children:"After aborting, we attempted to restart the ceremony but faced another bug. Nodes keep copies of the last successful DKG state and the most recent interim state. Comparing the new proposal against the interim state, rather than the complete state, caused rejection by the leader node and other nodes."}),"\n",(0,r.jsxs)(t.p,{children:["We instructed LoE members to stop their nodes, run ",(0,r.jsx)(t.code,{children:"drand dkg nuke --id default"}),", and restart their nodes, restoring the v1.5.x DKG state and refreshing the interim state. With some members unable to commit more time, we called off the ceremony."]}),"\n",(0,r.jsx)(t.h3,{id:"next-steps",children:(0,r.jsx)(t.strong,{children:"Next Steps"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Testnet LoE members who haven't run ",(0,r.jsx)(t.code,{children:"drand dkg nuke --id default"})," should do so at their earliest convenience."]}),"\n",(0,r.jsx)(t.li,{children:"The drand team will patch all identified issues and release a new version."}),"\n",(0,r.jsx)(t.li,{children:"The drand team will add additional testing for erroneous flows and DKG timeouts."}),"\n",(0,r.jsx)(t.li,{children:"We will instruct LoE members to upgrade more gradually ahead of any ceremony to identify issues sooner."}),"\n",(0,r.jsx)(t.li,{children:"We will perform an asynchronous testnet ceremony in the coming weeks."}),"\n",(0,r.jsx)(t.li,{children:"We will run a mainnet ceremony on v1.5.9 to ensure all required upgrade paths are met."}),"\n"]}),"\n",(0,r.jsx)(t.h3,{id:"final-thoughts",children:(0,r.jsx)(t.strong,{children:"Final Thoughts"})}),"\n",(0,r.jsx)(t.p,{children:"This was not a good look for the drand team. Drand v2 has been in the pipeline for over a year, and this is the second aborted ceremony in a row. We owe an apology to the League of Entropy members for wasting their time. This shouldn\u2019t happen."}),"\n",(0,r.jsx)(t.p,{children:"After numerous ceremonies last year, everyone is experiencing ceremony fatigue. Mandating early or late participation is unsustainable. v2 promises fully asynchronous ceremonies, eliminating the need for everyone to be online at once. The leader can start the ceremony, and members can join anytime over a week."}),"\n",(0,r.jsx)(t.p,{children:"Outages, especially in distributed systems, often result from multiple bugs in succession. This outage was no exception. In v2, many things changed, leading to a confluence of edge cases. We should have done many small releases instead of one large one."}),"\n",(0,r.jsx)(t.p,{children:"Thank you to everyone who participated. We are continually impressed by the professionalism and engagement of League of Entropy members. Without you, we wouldn\u2019t be running the flagship threshold network serving over a billion requests per month."}),"\n",(0,r.jsx)(t.hr,{})]})}function c(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>a});var r=n(6540);const o={},s=r.createContext(o);function i(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);